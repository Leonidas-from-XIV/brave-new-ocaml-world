\documentclass{beamer}
\usepackage{pgfplots}
\usepackage{minted}
\usepackage{multicol}

\usepgfplotslibrary{dateplot}
\usetheme{m}

\title{Brave New OCaml World}
\author{Marek Kubica @leonidasfromxiv}
\institute{\includegraphics[width=2cm]{lambdadays}}
\date{25.2.2015}

\titlegraphic{\includegraphics[width=\linewidth]{colour-transparent-logo}}
\pgfplotsset{compat=1.10}
%\pgfplotsset{compat=1.11}
%\defaultfontfeatures{Ligatures=TeX}

% Not sure we even want a logo
%\logo{\includegraphics[width=1cm]{colour-transparent-icon}}

\renewcommand{\itemBullet}{\hbox{\vrule width 1ex height 1ex}}
\setsansfont[BoldFont={Lato},ItalicFont={Lato Light Italic}]{Lato Light}
\newfontfamily\exclaim{Lato Black}

\newfontfamily\ExtraLight{Lato Light}
\newfontfamily\Light{Lato Light}
\newfontfamily\Medium{Lato Medium}
\begin{document}

\maketitle

\begin{frame}{Who am I even?}
  \begin{columns}[c]
    \column{.5\textwidth}
      \includegraphics[height=0.8\textheight]{programmers}
    \column{.5\textwidth}
      \begin{itemize}
        \item From Technische Universität München
        \item Introduction to Programming lecture with OCaml
        \item Then, Bachelor Thesis: OCaml
        \item Now, Master Thesis: OCaml
      \end{itemize}
  \end{columns}
\end{frame}

\begin{frame}{}
  \center
  \fontsize{70}{70} \exclaim Why?
\end{frame}

\begin{frame}{Quick feature list}
  \begin{itemize}
    \item Static Hindley-Milner type system with inference
    \item Powerful module system
    \item Fast in the average case
    \item Strict
    \item Easy to learn
    \item Quick native and byte code compilers
    \item Wide variety of platforms supported
    \item \emph{One} single language (not 70 language extensions)
    \item Macro system
    \item Good backwards compatibility
  \end{itemize}
\end{frame}

\begin{frame}{From a Python perspective}
  \begin{itemize}
    \item Stronger correctnes assurances due to type checking
    \item Faster execution
    \item Pattern matching
    \item Functionally focussed community
  \end{itemize}
\end{frame}

\begin{frame}{From a Haskell perspective}
  \begin{itemize}
    \item Language with \emph{much gentler} learning curve
    \item Module system: OCaml offers modules that can be parametrized
      with other modules \rightarrow Functors
  \end{itemize}
\end{frame}

\begin{frame}{js\_of\_ocaml}
  \begin{itemize}
    \item Take OCaml byte code, generate JavaScript code
    \item Surprisingly fast
    \item OCaml REPL in browser
    \item Alt-Ergo — a SMT solver in OCaml — running in browser
    \item Coupled with Ocsigen: OCaml on the front and backend, code sharing
  \end{itemize}
\end{frame}

\begin{frame}{But it's unpopular!}
  \#38 language on GitHub

  % logos
  {
  \renewcommand{\arraystretch}{2.5}
  \begin{tabular}{ccc}
    \includegraphics[height=1cm]{facebook} &
    \includegraphics[height=1cm]{citrix} &
    \includegraphics[height=1cm]{janestreet} \\
    \includegraphics[height=1cm]{ds} &
    \includegraphics[height=1cm]{galois} &
    \includegraphics[height=1cm]{shiro} \\
    \includegraphics[height=1cm]{esper} &
    \includegraphics[height=1cm]{issuu} &
  \end{tabular}
  }
  More: \url{https://ocaml.org/learn/companies.html}
\end{frame}

\begin{frame}{OPAM repository contributors}
  \begin{tikzpicture}
    \begin{axis}[
      xlabel=Time,
      ylabel=Contributors,
      ymin=0,
      %axis x line=bottom,
      %axis y line=left,
      enlargelimits=false,
      %enlarge x limits=upper,
      enlarge y limits={value=0.15,upper},
      grid=major,
      date coordinates in=x,
      xticklabel={\month.\year},
      xticklabel style={rotate=90},
      width=\textwidth,
      height=.8\textheight,
      try min ticks=9,
      ytick={0,50,...,300},
      fill opacity=0.8,
      ]

      \addplot [color=blue,fill=blue!50] table {contributors.csv}\closedcycle;
    \end{axis}
  \end{tikzpicture}
\end{frame}

\begin{frame}{Projects using OCaml}
  You might have heard some of these names
  \begin{multicols}{3}
  \begin{itemize}
    \item 0install
    \item Pfft
    \item Flow
    \item Hack
    \item Haxe
    \item Rust (previously)
    \item CompCert
    \item Frama-C
    \item FFTW
    \item Unison
    \item MLDonkey
    \item Coq
    \item Alt-Ergo
    \item Opalang
    \item Grenchman
  \end{itemize}
  \end{multicols}
  OCaml is a popular language for writing compilers and verification tools.
\end{frame}

\begin{frame}{This talk}
  So we saw that it seems to be pretty cool. Why is not everyone all over it?

  Most difficult part: getting started.

  Let me lend you a hand and give you some guidance.
\end{frame}

\section{Learning}

\begin{frame}{Real World OCaml}
  \begin{columns}[c]
    \column{.5\textwidth}
      \includegraphics[height=0.8\textheight]{rwo}
    \column{.5\textwidth}
      \begin{itemize}
        \item The best OCaml book ever published
        \item For more experienced developers
        \item Broad amount of topics covered: functional programming
          object orientation, runtime
        \item Uses Jane Street's Core Standard library
        \item Freely available online
      \end{itemize}
  \end{columns}
\end{frame}

\begin{frame}{OCaml from the very beginning}
  \begin{columns}[c]
    \column{.5\textwidth}
      \includegraphics[height=0.8\textheight]{very-beginning}
    \column{.5\textwidth}
      \begin{itemize}
        \item Introduction into functional programming
        \item More geared towards novices
        \item A bit like "The Little Schemer"
        \item Companion book "More OCaml" available
      \end{itemize}
  \end{columns}
\end{frame}

\begin{frame}{Communities}
  Learning in isolation is difficult
  \begin{itemize}
    \item \texttt{\#ocaml} on freenode
    \item ocaml\_beginners mailing list
    \item caml-list
    \item \texttt{ocaml} tag on Stack Overflow
  \end{itemize}
\end{frame}

\section{Editing}

\begin{frame}{Editor selection}
  \begin{columns}[t]
    \column{.5\textwidth}
    \begin{block}{Emacs}
      \begin{itemize}
        \item ocaml-mode
        \item Tuareg
      \end{itemize}
    \end{block}
    \begin{block}{Vim}
      \begin{itemize}
        \item OCaml syntax
        \item Operator replacement
      \end{itemize}
    \end{block}
    \begin{block}{Eclipse}
      OCaml Development Tools
    \end{block}
    \column{.5\textwidth}
    \begin{block}{Merlin}
      Helper that \emph{understands} OCaml code. Offers \emph{sensible}
      completion, type inference, renaming, definition location.
      \begin{itemize}
        \item Vim
        \item Emacs
        \item Sublime Text
      \end{itemize}
    \end{block}
  \end{columns}
\end{frame}

\begin{frame}{Merlin in action}
  I wonder what the \texttt{List} module supports?

  \pause
  \includegraphics[width=\textwidth]{vim_complete}
\end{frame}

\section{Building}

\begin{frame}{Building code sucks}
  \begin{itemize}
    \item Getting inter-project dependencies
    \item Getting inter-file dependencies
    \item Incrementally rebuilding
    \item Build times
    \item Compiler options
  \end{itemize}
  In Haskell, this is all handled by Cabal
\end{frame}

\begin{frame}{Building OCaml code used to suck}
  \begin{itemize}
    \item \texttt{.ml}/\texttt{.mli}: source files
    \item \texttt{.o}: Compiled C implementations
    \item \texttt{.cmo}/\texttt{.cmi}: Compiled modules
    \item \texttt{.cma}/\texttt{.cmax}: Compiled module archives, native archives
    \item \texttt{.cmt}/\texttt{.cmti}: Type information annotation
  \end{itemize}
  \begin{itemize}
    \item \texttt{ocamlc}, \texttt{ocamlc.opt}
    \item \texttt{ocamlopt}, \texttt{ocamlopt.opt}
    \item \texttt{ocamldep}
    \item …
  \end{itemize}
  Need to compile each module, specify them in the proper order.
\end{frame}

\subsection{ocamlfind}

\begin{frame}{ocamlfind}
  The OCaml compiler knows no packages, just modules.
  \begin{itemize}
    \item Additional tool by Gerd Stolpman
    \item \texttt{ocamlfind} \emph{finds} packages
    \item Wrapper around commandline tools, \texttt{ocamlfind ocamlopt}
    \item Adds a \texttt{-package} option
    \item Reads information from \texttt{META} file
    \item Universally established tool
  \end{itemize}
  Package/dependency problem solved.
\end{frame}

\begin{frame}{ocamlbuild}
  Previously: no build system shipped.

  Cue: OMake, obuild, ocp-build, jenga, GNU Make.

  \begin{itemize}
    \item OCaml 3.12 came with \texttt{ocamlbuild}
    \item Ships with default rules to invoke compiler toolchain
    \item \texttt{\_tags} file for customization
    \item Quite alright for small to medium projects
    \item Popular but not ubiquitous
  \end{itemize}
\end{frame}

\begin{frame}{Too much config!}
  So you need to write

  \begin{itemize}
    \item Configuration script (think \texttt{./configure})
    \item \texttt{META}
    \item \texttt{\_tags}
  \end{itemize}

  If we just had a declarative tool to generate this cruft…
\end{frame}

\begin{frame}{Enter OASIS}
  "Architecture for building OCaml libraries and applications"

  \begin{itemize}
    \item \texttt{\_oasis} file with definitions
    \item Can generate files for \texttt{ocamlfind}, \texttt{ocamlbuild}
    \item Supports other systems via plugin (in theory)
    \item "One system to bind them"
  \end{itemize}
\end{frame}

\begin{frame}[fragile]{\_oasis}
  \texttt{\_oasis} files are easy to write
  \begin{minted}[fontsize=\scriptsize]{text}
OASISFormat:  0.4
Name:         pkg
Version:      0.12.0
Synopsis:     Example library for LambdaDays
Authors:      Marek Kubica
License:      LGPL-3 with OCaml linking exception
Plugins:      META (0.4), DevFiles (0.4)
BuildTools:   ocamlbuild
BuildDepends: cohttp.lwt, yojson

Library pkg
  Path:           src
  BuildDepends:   lwt.ppx
  Modules:        Pkg
  ByteOpt:        -safe-string
  NativeOpt:      -safe-string
  CompiledObject: best
  \end{minted}
\end{frame}

\section{Testing}

\begin{frame}{Different kinds of testing}
  \begin{itemize}
    \item Assertion-based testing (xUnit)
    \item Property-based testing (QuickCheck)
    \item Enumeration-based testing (SmallCheck)
    \item Continuous integration (Travis CI)
  \end{itemize}
\end{frame}

\begin{frame}[fragile]{Unit testing}
  Most popular library is OUnit.
  \begin{minted}{ocaml}
open OUnit2

let test_commutative test_ctx =
  assert_equal (1+2) (2+1)

let suite = "Example" >::: [
  "addition" >:: test_commutative;
]

let _ = run_test_tt_main suite
  \end{minted}
  \texttt{pa\_ounit} syntax extension for less overhead.
\end{frame}

\begin{frame}[fragile]{Specification testing}
  Let's check whether OCaml integers are commutative
  \begin{minted}{ocaml}
open QCheck

let test = mk_test ~name:"commutative"
  Arbitrary.(pair small_int small_int)
  (fun (a, b) -> a + b = b + a)

let _ = ignore @@ run test
  \end{minted}
  The Kaputt package supports also enumeration-based testing
\end{frame}

\begin{frame}[fragile]{Continuous integration}
  "It works on \emph{my} machine" \pause Better build it independently on Travis CI.

  Add this to your \texttt{.travis.yml}, ocaml-travisci-skeleton will take care of
  the rest (as long as your package is OPAMized).
  \begin{minted}{yaml}
language: c
install: wget https://…/.travis-opam.sh
script: bash -ex .travis-opam.sh
env:
- OCAML_VERSION=4.02
- OCAML_VERSION=4.01
- OCAML_VERSION=4.00
- OCAML_VERSION=3.12
  \end{minted}
\end{frame}

\section{Distributing}

\begin{frame}{The need for distribution}
  Do not reinvent the wheel, let's use existing libraries!

  So, if OASIS is like Cabal, what is the equivalent to Hackage? \pause

  There was a project called OASIS-DB, but it didn't work out.
\end{frame}

\begin{frame}{OPAM}
  Lessons learned from OASIS-DB.
  \begin{itemize}
    \item OCaml PAckage Manager
    \item Manages building \emph{compiler} and packages
    \item Uses community-maintained Git repo with build recipes
    \item Describes packages:
      \begin{itemize}
        \item Version, source tarball, hash
        \item Dependencies, conflicts
        \item Installation scripts \& patches
      \end{itemize}
    \item SAT solver to solve requests
    \item Does not enforce any build system, project structure
    \item Handles updates and removals
  \end{itemize}
\end{frame}

\begin{frame}{OPAM stats: packages}
  \begin{tikzpicture}
    \begin{axis}[
      xlabel=Time,
      ylabel=Packages,
      ymin=0,
      xmin=2012-08-21,
      %axis x line=bottom,
      %axis y line=left,
      enlargelimits=false,
      %enlarge x limits=upper,
      enlarge y limits=upper,
      grid=major,
      date coordinates in=x,
      xticklabel={\month.\year},
      xticklabel style={rotate=90},
      legend entries={Total, Unique},
      legend style={legend pos=north west},
      width=\textwidth,
      height=.8\textheight,
      ytick={0,500,...,3500},
      ]

      \addplot [color=red,fill=red!50, fill opacity=0.8] table {packages.csv}\closedcycle;
      \addplot [color=blue,fill=blue!50, fill opacity=0.6] table {unique-packages.csv}\closedcycle;
    \end{axis}
  \end{tikzpicture}
\end{frame}


\section{Documenting}

\begin{frame}[fragile]{Projects need documentation}
  OCaml goes the Javadoc route: \texttt{ocamldoc}. Shipped with the compiler.
  \begin{minted}[fontsize=\small]{ocaml}
(** Documentation of function
    @param arg1 What the param is for
    @param arg2 More documentation *)
  \end{minted}
  Best to be used on \texttt{.mli} (module interface) files.

  Uses custom documentation markup format.

  Future: OPAM-Doc to generate documentation of every installed package.
\end{frame}

\begin{frame}{OCamlOScope}
  \begin{centering}
    \includegraphics[width=\textwidth]{ocamloscope}
  \end{centering}
  "Signature goes in, function comes out — can't explain that."

  API search for OCaml, like Hoogle/Hayoo. Searches top ~100 OPAM packages.
\end{frame}

\section{What's coming}

\begin{frame}{Concurrency}
  Multithreaded OCaml runtime not yet a thing.

  In the works, but no definite timeframe. Libraries to parallelize execution
  to multiple processes exist.

  Who cares about threads, right? Async evented I/O! Monadic concurrency
  libraries.
  \begin{enumerate}
    \item Lwt
    \item Async
  \end{enumerate}
\end{frame}

\begin{frame}[fragile]{Lwt in action}
  \begin{minted}[fontsize=\small]{ocaml}
let channels_history token ?count channel =
  let%lwt channel_id = id_of_channel token channel in
  endpoint "channels.history"
    |> definitely_add "token" token
    |> definitely_add "channel" channel_id
    |> optionally_add "count"
       @@ maybe string_of_int count
    |> query
    >|= function
    | `Json_response d -> d |> history_obj_of_yojson
    | #history_result as res -> res
    | _ -> `Unknown_error
  \end{minted}
	\texttt{let\%lwt} is processed by a macro to work like \texttt{bind}.
\end{frame}

\begin{frame}{JVM}
  .NET has F\# (basically OCaml for .NET), a statically typed ML. It's a serious
  effort by Microsoft.

  JVM users have… Yeti? Scala? \pause

  \begin{block}{OCaml-Java}
    \begin{itemize}
      \item generates JVM bytecode
      \item based on OCaml 4.01
      \item faster than byte code
      \item slower than native code
      \item early effort
    \end{itemize}
  \end{block}

\end{frame}

\section{What's missing}

\begin{frame}{Debugging}
  \begin{itemize}
    \item \texttt{ocamldebug} exists
    \item Works on bytecode
    \item Can breakpoint on \emph{time} and even travel back
    \item Tends to step into Stdlib often
    \item Can't display abstract values
    \item Buggy
  \end{itemize}
  Print debugging to the rescue? Nah…
\end{frame}

\begin{frame}{Profiling}
  \begin{itemize}
    \item \texttt{ocamlprof} and \texttt{gprof} exist
    \item Work on byte/native code respectively
    \item Not right granularity
    \item Call count display incredibly inconvenient
    \item Buggy
  \end{itemize}
\end{frame}

\begin{frame}{Better integration}
  TODO
\end{frame}

\begin{frame}{Questions?}
  \centering
  \includegraphics[height=.85\textheight]{camel}
\end{frame}

\end{document}
