\documentclass{beamer}
\usepackage{pgfplots}
\usepackage{minted}

\usepgfplotslibrary{dateplot}
\usetheme{m}

\title{Brave New OCaml World}
\author{Marek Kubica @leonidasfromxiv}
\institute{Lambda Days}
\date{25.2.2015}

\titlegraphic{\includegraphics[width=\linewidth]{colour-transparent-logo}}
\pgfplotsset{compat=1.10}
%\pgfplotsset{compat=1.11}

% Not sure we even want a logo
%\logo{\includegraphics[width=1cm]{colour-transparent-icon}}

\renewcommand{\itemBullet}{\hbox{\vrule width 1ex height 1ex}}
\setsansfont[BoldFont={Lato},ItalicFont={Lato Light Italic}]{Lato Light}
\newfontfamily\exclaim{Lato Black}

\newfontfamily\ExtraLight{Lato Light}
\newfontfamily\Light{Lato Light}
\newfontfamily\Medium{Lato Medium}
\begin{document}

\maketitle

\begin{frame}{Who am I even?}
  \begin{columns}[c]
    \column{.5\textwidth}
      \includegraphics[height=0.8\textheight]{programmers}
    \column{.5\textwidth}
      \begin{itemize}
        \item From Technische Universität München
        \item Introduction to Programming lecture with OCaml
        \item Then, Bachelor Thesis: OCaml
        \item Now, Master Thesis: OCaml
      \end{itemize}
  \end{columns}
\end{frame}

\begin{frame}{}
  \center
  \fontsize{70}{70} \exclaim Why?
\end{frame}

\begin{frame}{Quick feature list}
  \begin{itemize}
    \item Static Hindley-Milner type system with inference
    \item Fast
    \item Strict
    \item Quick native and byte code compilers
    \item Wide variety of platforms supported
    \item One single language (not 70 language extensions)
    \item Macro system
    \item Good backwards compatibility
  \end{itemize}
\end{frame}

\begin{frame}{But it's unpopular!}
  \#38 language on GitHub

  % logos
  \includegraphics[height=1cm]{facebook}
  \includegraphics[height=1cm]{citrix}
  \includegraphics[height=1cm]{janestreet}
  \includegraphics[height=1cm]{esper}
  \includegraphics[height=1cm]{galois}
  \includegraphics[height=1cm]{shiro}
  \includegraphics[height=1cm]{ds}
  \includegraphics[height=1cm]{issuu}
  % TODO
\end{frame}

\begin{frame}{OPAM stats: packages}
  \begin{tikzpicture}
    \begin{axis}[
      xlabel=Time,
      ylabel=Packages,
      ymin=0,
      xmin=2012-08-21,
      %axis x line=bottom,
      %axis y line=left,
      enlargelimits=false,
      %enlarge x limits=upper,
      enlarge y limits=upper,
      grid=major,
      date coordinates in=x,
      xticklabel={\month.\year},
      xticklabel style={rotate=90},
      legend entries={Total, Unique},
      legend style={legend pos=north west},
      width=\textwidth,
      height=.8\textheight,
      ytick={0,500,...,3500},
      ]

      \addplot [color=red,fill=red!50, fill opacity=0.8] table {packages.csv}\closedcycle;
      \addplot [color=blue,fill=blue!50, fill opacity=0.6] table {unique-packages.csv}\closedcycle;
    \end{axis}
  \end{tikzpicture}
\end{frame}

\begin{frame}{OPAM stats: OPAM repository contributors}
  \begin{tikzpicture}
    \begin{axis}[
      xlabel=Time,
      ylabel=Contributors,
      ymin=0,
      %axis x line=bottom,
      %axis y line=left,
      enlargelimits=false,
      %enlarge x limits=upper,
      enlarge y limits={value=0.15,upper},
      grid=major,
      date coordinates in=x,
      xticklabel={\month.\year},
      xticklabel style={rotate=90},
      width=\textwidth,
      height=.8\textheight,
      try min ticks=9,
      ytick={0,50,...,300},
      fill opacity=0.8,
      ]

      \addplot [color=blue,fill=blue!50] table {contributors.csv}\closedcycle;
    \end{axis}
  \end{tikzpicture}
\end{frame}

\section{Learning}

\begin{frame}{Real World OCaml}
  \begin{columns}[c]
    \column{.5\textwidth}
      \includegraphics[height=0.8\textheight]{rwo}
    \column{.5\textwidth}
      \begin{itemize}
        \item The best OCaml book ever published
        \item For more experienced developers
        \item Broad amount of topics covered: functional programming
          object orientation, runtime
        \item Uses Jane Street's Core Standard library
        \item Freely available online
      \end{itemize}
  \end{columns}
\end{frame}

\begin{frame}{OCaml from the very beginning}
  \begin{columns}[c]
    \column{.5\textwidth}
      \includegraphics[height=0.8\textheight]{very-beginning}
    \column{.5\textwidth}
      \begin{itemize}
        \item Introduction into functional programming
        \item More geared towards novices
        \item A bit like "The Little Schemer"
        \item Companion book "More OCaml" available
      \end{itemize}
  \end{columns}
\end{frame}

\section{Editing}

\begin{frame}{Editor selection}
  \begin{columns}[t]
    \column{.5\textwidth}
    \begin{block}{Emacs}
      \begin{itemize}
        \item ocaml-mode
        \item Tuareg
      \end{itemize}
    \end{block}
    \begin{block}{Vim}
      \begin{itemize}
        \item OCaml syntax
        \item Operator replacement
      \end{itemize}
    \end{block}
    \begin{block}{Eclipse}
      OCaml Development Tools
    \end{block}
    \column{.5\textwidth}
    \begin{block}{Merlin}
      Helper that \emph{understands} OCaml code. Offers \emph{sensible}
      completion, type inference, renaming, definition location.
      \begin{itemize}
        \item Vim
        \item Emacs
        \item Sublime Text
      \end{itemize}
    \end{block}
  \end{columns}
\end{frame}

\begin{frame}{Merlin in action}
  I wonder what the List module supports?

  \pause
  \includegraphics[width=\textwidth]{vim_complete}
\end{frame}

\section{Building}

\begin{frame}{Building code sucks}
  \begin{itemize}
    \item Getting inter-project dependencies
    \item Getting inter-file dependencies
    \item Incrementally rebuilding
    \item Build times
    \item Compiler options
  \end{itemize}
  In Haskell, this is all handled by cabal
\end{frame}

\begin{frame}{Building OCaml code used to suck}
  \begin{itemize}
    \item .ml/.mli: source files
    \item .o: Compiled C modules
    \item .cmo/.cmi: Compiled modules
    \item .cma/.cmax: Compiled module archives, native archives
    \item .cmt: Type information annotation
  \end{itemize}
  \begin{itemize}
    \item ocamlc, ocamlc.opt
    \item ocamlopt, ocamlopt.opt
    \item ocamldep
    \item …
  \end{itemize}
  Need to compile each module, specify them in the proper order.
\end{frame}

\subsection{ocamlfind}

\begin{frame}{ocamlfind}
  The OCaml compiler knows no packages, just modules.
  \begin{itemize}
    \item Additional tool by Gerd Stolpman
    \item \texttt{ocamlfind} \emph{finds} packages
    \item Wrapper around commandline tools, \texttt{ocamlfind ocamlopt}
    \item Adds a \texttt{-package} option
    \item Reads information from \texttt{META} file
    \item Universally established tool
  \end{itemize}
  Package/dependency problem solved.
\end{frame}

\begin{frame}{ocamlbuild}
  Previously: no build system shipped.

  Cue: OMake, obuild, ocp-build, jenga, GNU Make.

  \begin{itemize}
    \item OCaml 3.12 came with \texttt{ocamlbuild}
    \item Ships with default rules to invoke compiler toolchain
    \item \texttt{\_tags} file for customization
    \item Quite alright for small to medium projects
    \item Popular but not ubiquitous
  \end{itemize}
\end{frame}

\begin{frame}{Too much config!}
  So you need to write

  \begin{itemize}
    \item \texttt{META}
    \item \texttt{\_tags}
  \end{itemize}

  If we just had a declarative tool to generate this cruft.
\end{frame}

\begin{frame}{Enter OASIS}
  "Architecture for building OCaml libraries and applications"

  \begin{itemize}
    \item \texttt{\_oasis} file with definitions
    \item Can generate files for \texttt{ocamlfind}, \texttt{ocamlbuild}
    \item Supports other systems via plugin (in theory)
    \item "One system to bind them"
  \end{itemize}
\end{frame}

\begin{frame}[fragile]{\_oasis}
  \texttt{\_oasis} files are easy to write
  \begin{minted}[fontsize=\scriptsize]{text}
OASISFormat:  0.4
Name:         pkg
Version:      0.12.0
Synopsis:     Example library for LambdaDays
Authors:      Marek Kubica
License:      LGPL-3 with OCaml linking exception
Plugins:      META (0.4), DevFiles (0.4)
BuildTools:   ocamlbuild
BuildDepends: cohttp.lwt, yojson

Library pkg
  Path:           src
  BuildDepends:   lwt.ppx
  Modules:        Pkg
  ByteOpt:        -safe-string
  NativeOpt:      -safe-string
  CompiledObject: best
  \end{minted}
\end{frame}

\section{Testing}

\begin{frame}{Different kinds of testing}
  \begin{itemize}
    \item Assertion-based testing (xUnit)
    \item Property-based testing (QuickCheck)
    \item Enumeration-based testing (SmallCheck)
    \item Continuous integration (Travis CI)
  \end{itemize}
\end{frame}

\begin{frame}[fragile]{Unit testing}
  Most popular library is OUnit.
  \begin{minted}{ocaml}
open OUnit2

let test_commutative test_ctx =
  assert_equal (1+2) (2+1)

let suite = "Example" >::: [
  "addition" >:: test_commutative;
]

let _ = run_test_tt_main suite
  \end{minted}
  \texttt{pa\_ounit} syntax extension for less overhead.
\end{frame}

\begin{frame}[fragile]{Specification testing}
  Let's check whether OCaml integers are commutative
  \begin{minted}{ocaml}
open QCheck

let test = mk_test ~name:"commutative"
  Arbitrary.(pair small_int small_int)
  (fun (a, b) -> a + b = b + a)

let _ = ignore @@ run test
  \end{minted}
  The Kaputt package supports also enumeration-based testing
\end{frame}

\begin{frame}[fragile]{Continuous integration}
  "It works on \emph{my} machine" \pause Build it independently on Travis CI.

  Add this to your \texttt{.travis.yml}, ocaml-travisci-skeleton will take care of
  the rest (as long as your package is OPAMized).
  \begin{minted}{yaml}
language: c
install: wget https://…/.travis-opam.sh
script: bash -ex .travis-opam.sh
env:
- OCAML_VERSION=4.02
- OCAML_VERSION=4.01
- OCAML_VERSION=4.00
- OCAML_VERSION=3.12
  \end{minted}
\end{frame}

\section{Distributing}

\begin{frame}{The need for distribution}
  Do not reinvent the wheel, let's use existing libraries!

  So, if OASIS is like Cabal, what is the equivalent to Hackage? \pause

  There was a project called OASIS-DB, but it didn't work out.
\end{frame}

\begin{frame}{OPAM}
  \begin{itemize}
    \item OCaml PAckage Manager
    \item Manages building \emph{compiler} and packages
    \item Uses community-maintained Git repo with build recipes
    \item Describes packages:
      \begin{itemize}
        \item Version, source tarball, hash
        \item Dependencies, conflicts
        \item SAT solver to solve requests
      \end{itemize}
    \item Does not enforce any build system, project structure
    \item Handles updates and removals
  \end{itemize}
\end{frame}

\section{Documenting}

\section{What's coming}

\section{What's missing}

\begin{frame}{Questions?}
  \centering
  \includegraphics[height=.85\textheight]{camel}
\end{frame}

\end{document}
